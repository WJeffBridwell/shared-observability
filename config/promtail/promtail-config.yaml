server:
  http_listen_port: 9080
  grpc_listen_port: 0
  log_level: info

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push
    tenant_id: default
    batchwait: 1s
    batchsize: 1048576
    timeout: 10s

scrape_configs:
  # Docker container logs via Docker API (docker_sd_configs reads from Docker daemon directly)
  - job_name: docker
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: network
            values: ['observability-network']
    relabel_configs:
      # Extract container name (strip leading slash)
      - source_labels: [__meta_docker_container_name]
        regex: '/(.*)'
        target_label: container_name

      # Extract compose service name
      - source_labels: [__meta_docker_container_label_com_docker_compose_service]
        target_label: service

      # Extract compose project name
      - source_labels: [__meta_docker_container_label_com_docker_compose_project]
        target_label: project

      # Extract custom appName label if present
      - source_labels: [__meta_docker_container_label_appName]
        target_label: appName

    pipeline_stages:
      # Parse Docker JSON log wrapper
      - docker: {}
      # Drop internal observability container logs (relabel drop doesn't work in Docker SD)
      - match:
          selector: '{container_name=~"prometheus|grafana|loki|promtail|node-exporter|alertmanager|blackbox-exporter|mysqld-exporter"}'
          action: drop

  # Host-level operational logs (Chorus audit, guardrails, deploy events)
  - job_name: chorus-operations
    static_configs:
      - targets:
          - localhost
        labels:
          job: chorus-operations
          __path__: /host-logs/chorus.log

    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            appName: appName
            component: component
            role: role
            check: check
            decision: decision
            pattern: pattern
            message: message

      - labels:
          level:
          appName:
          component:
          role:

      - timestamp:
          source: timestamp
          format: '2006-01-02T15:04:05.000Z'

      - output:
          source: message
